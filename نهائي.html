<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --light-color: #ecf0f1;
      --success-color: #27ae60;
      --warning-color: #f39c12;
    }
    * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: #f5f7fa; margin: 0; color: #333; direction: rtl; }
    header { background: var(--primary-color); color: #fff; padding: 15px; }
    .header-content { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-weight: bold; font-size: 1.2rem; }
    .container { width: 90%; max-width: 1100px; margin: 20px auto; }
    .btn { padding: 8px 14px; border: 0; border-radius: 6px; cursor: pointer; background: var(--secondary-color); color: #fff; margin: 4px; }
    .btn-danger { background: var(--accent-color); }
    .btn-success { background: var(--success-color); }
    .btn-warning { background: var(--warning-color); }
    .btn-info { background: var(--primary-color); }
    .card { background: #fff; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,.1); margin-bottom: 20px; overflow: hidden; }
    .card-header { background: var(--light-color); padding: 12px; font-weight: bold; }
    .card-body { padding: 14px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: right; }
    th { background: var(--light-color); }
    .hidden { display: none; }
    .stats { display: flex; flex-wrap: wrap; gap: 12px; }
    .stat-item { flex: 1; min-width: 150px; background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,.1); text-align: center; }
    .edit-input { width: 80px; padding: 4px; margin: 2px; }
    .edit-mode { background-color: #fffacd; }
    .main-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .menu-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
    .menu-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); border-color: var(--secondary-color); }
    .menu-btn i { font-size: 2rem; margin-bottom: 10px; }
    .backup-section { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; }
    .backup-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
  </style>
</head>
<body>
  <header>
    <div class="header-content container">
      <div class="logo">ğŸ’¼ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
      <div>Ù…/ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù„Ø·Ù Ø§Ù„Ø¯ÙŠÙ„Ù…ÙŠ</div>
    </div>
  </header>

  <div class="container">
    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginScreen" class="card">
      <div class="card-header">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
      <div class="card-body">
        <input type="password" id="loginPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
        <button class="btn btn-success" onclick="checkPassword()">ğŸ”“ Ø¯Ø®ÙˆÙ„</button>
      </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <div id="dashboard" class="hidden">
      <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - Ø£ØµØ¨Ø­Øª Ø£ÙˆÙ„ Ù…Ø­ØªÙˆÙ‰ -->
      <div class="card">
        <div class="card-header">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="card-body">
          <div class="main-menu">
            <div class="menu-btn" onclick="showSection('stats')">
              <div>ğŸ“Š</div>
              <span>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©</span>
            </div>
            <div class="menu-btn" onclick="showSection('summary')">
              <div>ğŸ“ˆ</div>
              <span>Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</span>
            </div>
            <div class="menu-btn" onclick="showSection('add')">
              <div>â•</div>
              <span>Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨</span>
            </div>
            <div class="menu-btn" onclick="showSection('view')">
              <div>ğŸ‘ï¸</div>
              <span>Ø¹Ø±Ø¶ Ø­Ø³Ø§Ø¨</span>
            </div>
            <div class="menu-btn" onclick="showSection('delete')">
              <div>ğŸ—‘ï¸</div>
              <span>Ø­Ø°Ù Ø­Ø³Ø§Ø¨</span>
            </div>
            <div class="menu-btn" onclick="showSection('list')">
              <div>ğŸ“‹</div>
              <span>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</span>
            </div>
            <div class="menu-btn" onclick="showSection('backup')">
              <div>ğŸ›¡ï¸</div>
              <span>Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</span>
            </div>
            <div class="menu-btn" onclick="showSection('password')">
              <div>ğŸ”</div>
              <span>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
      <div id="statsSection" class="card hidden">
        <div class="card-header">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©</div>
        <div class="card-body">
          <canvas id="accountsChart" style="max-width:800px; height: 400px;"></canvas>
          <div class="stats" id="statsContainer"></div>
        </div>
      </div>

      <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª -->
      <div id="summarySection" class="card hidden">
        <div class="card-header">ğŸ“ˆ Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
        <div class="card-body">
          <table id="summaryTable">
            <thead>
              <tr>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…</th>
                <th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø³Ø­Ø¨</th>
                <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ -->
      <div id="backupSection" class="card hidden">
        <div class="card-header">ğŸ›¡ï¸ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</div>
        <div class="card-body">
          <div class="backup-section">
            <h4>ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
            <div class="backup-buttons">
              <button class="btn btn-success" onclick="backupData()">Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ (JSON)</button>
              <button class="btn btn-success" onclick="exportToCSV()">ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ CSV</button>
              <button class="btn btn-success" onclick="exportToExcelAll()">ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
            </div>
          </div>
          
          <div class="backup-section">
            <h4>ğŸ“¥ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
            <div class="backup-buttons">
              <button class="btn btn-warning" onclick="document.getElementById('restoreFile').click()">
                Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† JSON
              </button>
              <input type="file" id="restoreFile" accept=".json" style="display:none" onchange="restoreData(event)">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ù„Ø© -->

    <!-- Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ -->
    <div id="addForm" class="card hidden">
      <div class="card-header">â• Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</div>
      <div class="card-body">
        <input id="addName" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…" /><br />
        <input id="addQuantity" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" /><br />
        <input id="addValue" type="number" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©" /><br />
        <input id="addWithdraw" type="number" placeholder="Ø§Ù„Ø³Ø­Ø¨" /><br />
        <input id="addInform" placeholder="Ø§Ù„ØªÙØ§ØµÙŠÙ„" /><br />
        <button class="btn btn-success" onclick="saveAccount()">ğŸ’¾ Ø­ÙØ¸</button>
        <button class="btn" onclick="showMainMenu()">â¬…ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      </div>
    </div>

    <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø³Ø§Ø¨ -->
    <div id="viewForm" class="card hidden">
      <div class="card-header">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø­Ø³Ø§Ø¨</div>
      <div class="card-body">
        <input id="viewName" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…" />
        <button class="btn" onclick="viewAccount()">ğŸ“‚ Ø¹Ø±Ø¶</button>
        <button class="btn" onclick="exportToExcel()">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
        <button class="btn btn-warning" onclick="toggleEditMode()">âœï¸ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        <div id="viewResult"></div>
        <button class="btn" onclick="showMainMenu()">â¬…ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      </div>
    </div>

    <!-- Ø­Ø°Ù Ø­Ø³Ø§Ø¨ -->
    <div id="deleteForm" class="card hidden">
      <div class="card-header">ğŸ—‘ï¸ Ø­Ø°Ù Ø­Ø³Ø§Ø¨</div>
      <div class="card-body">
        <input id="deleteName" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…" />
        <button class="btn btn-danger" onclick="deleteAccount()">âŒ Ø­Ø°Ù</button>
        <div id="deleteResult"></div>
        <button class="btn" onclick="showMainMenu()">â¬…ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª -->
    <div id="accountsListForm" class="card hidden">
      <div class="card-header">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
      <div class="card-body" id="accountsList"></div>
      <button class="btn" onclick="showMainMenu()">â¬…ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
    </div>

    <!-- ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
    <div id="changePasswordForm" class="card hidden">
      <div class="card-header">ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div>
      <div class="card-body">
        <input type="password" id="oldPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©"><br />
        <input type="password" id="newPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"><br />
        <input type="password" id="confirmPassword" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"><br />
        <button class="btn btn-success" onclick="changePassword()">âœ”ï¸ ØªØºÙŠÙŠØ±</button>
        <div id="passwordChangeResult"></div>
        <button class="btn" onclick="showMainMenu()">â¬…ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      </div>
    </div>

  </div>

  <script>
    if (!localStorage.getItem("accountPassword")) {
      localStorage.setItem("accountPassword", "132456");
    }

    let chartInstance = null;
    let isEditMode = false;
    let currentAccountName = '';

    function checkPassword() {
      const entered = document.getElementById("loginPassword").value;
      const saved = localStorage.getItem("accountPassword");
      if (entered === saved) {
        document.getElementById("loginScreen").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        showMainMenu();
      } else { 
        alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); 
      }
    }

    function showMainMenu() {
      hideAllSections();
      hideAllForms();
      document.getElementById("dashboard").classList.remove("hidden");
      renderStats();
    }

    function showSection(sectionId) {
      hideAllSections();
      hideAllForms();
      
      switch(sectionId) {
        case 'stats':
          document.getElementById("statsSection").classList.remove("hidden");
          renderStats();
          break;
        case 'summary':
          document.getElementById("summarySection").classList.remove("hidden");
          renderSummaryTable();
          break;
        case 'add':
          document.getElementById("addForm").classList.remove("hidden");
          break;
        case 'view':
          document.getElementById("viewForm").classList.remove("hidden");
          isEditMode = false;
          document.querySelector('#viewForm .btn-warning').textContent = 'âœï¸ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
          document.querySelector('#viewForm .btn-warning').classList.add('btn-warning');
          document.querySelector('#viewForm .btn-warning').classList.remove('btn-success');
          break;
        case 'delete':
          document.getElementById("deleteForm").classList.remove("hidden");
          break;
        case 'list':
          document.getElementById("accountsListForm").classList.remove("hidden");
          listAccounts();
          break;
        case 'backup':
          document.getElementById("backupSection").classList.remove("hidden");
          break;
        case 'password':
          document.getElementById("changePasswordForm").classList.remove("hidden");
          break;
      }
    }

    function hideAllSections() {
      const sections = [
        "statsSection",
        "summarySection",
        "backupSection"
      ];
      sections.forEach(sid => {
        document.getElementById(sid).classList.add("hidden");
      });
    }

    function hideAllForms() {
      const forms = [
        "addForm",
        "viewForm",
        "deleteForm",
        "accountsListForm",
        "changePasswordForm"
      ];
      forms.forEach(fid => {
        document.getElementById(fid).classList.add("hidden");
      });
    }

    function saveAccount() {
      const name = document.getElementById('addName').value.trim();
      const quantity = Number(document.getElementById('addQuantity').value);
      const value = Number(document.getElementById('addValue').value);
      const withdraw = Number(document.getElementById('addWithdraw').value);
      const inform = document.getElementById('addInform').value;
      const date = new Date().toLocaleDateString('ar-EG');
      const total = quantity * value;
      
      if (!name || isNaN(quantity) || isNaN(value) || isNaN(withdraw)) { 
        alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„"); 
        return; 
      }
      
      const record = { quantity, value, withdraw, total, date, inform };
      const data = JSON.parse(localStorage.getItem("accounts") || "{}");
      if (!data[name]) data[name] = [];
      data[name].push(record);
      localStorage.setItem("accounts", JSON.stringify(data));
      
      // Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ
      autoBackup();
      
      alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
      document.getElementById('addName').value = '';
      document.getElementById('addQuantity').value = '';
      document.getElementById('addValue').value = '';
      document.getElementById('addWithdraw').value = '';
      document.getElementById('addInform').value = '';
    }

    function viewAccount() {
      const name = document.getElementById('viewName').value.trim();
      currentAccountName = name;
      const data = JSON.parse(localStorage.getItem("accounts") || "{}");
      const container = document.getElementById("viewResult");
      if (!data[name]) { 
        container.innerHTML = "<p style='color:red;'>âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>"; 
        return; 
      }
      
      if (isEditMode) {
        renderEditableAccount(data[name], container, name);
      } else {
        renderReadOnlyAccount(data[name], container, name);
      }
    }

    function renderReadOnlyAccount(records, container, name) {
      let rows = "", sumTotal = 0, sumWithdraw = 0;
      records.forEach((r, index) => { 
        rows += `<tr>
          <td>${r.quantity}</td>
          <td>${r.value}</td>
          <td>${r.withdraw}</td>
          <td>${r.total}</td>
          <td>${r.date}</td>
          <td>${r.inform}</td>
        </tr>`; 
        sumTotal += r.total; 
        sumWithdraw += r.withdraw; 
      });
      
      const remaining = sumTotal - sumWithdraw;
      container.innerHTML = `
        <table id="accountTable">
          <tr>
            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
            <th>Ø§Ù„Ø³Ø­Ø¨</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
          </tr>
          ${rows}
          <tr style='font-weight:bold;background:#ffd'>
            <td colspan=3>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</td>
            <td>${sumTotal}</td>
            <td colspan=2></td>
          </tr>
          <tr style='font-weight:bold;background:#fdd'>
            <td colspan=3>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø³Ø­Ø¨:</td>
            <td>${sumWithdraw}</td>
            <td colspan=2></td>
          </tr>
          <tr style='font-weight:bold;background:#dfd'>
            <td colspan=3>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</td>
            <td>${remaining}</td>
            <td colspan=2></td>
          </tr>
        </table>`;
    }

    function renderEditableAccount(records, container, name) {
      let rows = "", sumTotal = 0, sumWithdraw = 0;
      
      records.forEach((r, index) => { 
        rows += `<tr class="edit-mode">
          <td><input type="number" class="edit-input" value="${r.quantity}" id="editQty${index}"></td>
          <td><input type="number" class="edit-input" value="${r.value}" id="editVal${index}"></td>
          <td><input type="number" class="edit-input" value="${r.withdraw}" id="editWithdraw${index}"></td>
          <td><span id="editTotal${index}">${r.quantity * r.value}</span></td>
          <td>${r.date}</td>
          <td><input type="text" class="edit-input" value="${r.inform}" id="editInform${index}"></td>
          <td>
            <button class="btn btn-success" onclick="updateRecord(${index})">ğŸ’¾</button>
            <button class="btn btn-danger" onclick="deleteRecord(${index})">ğŸ—‘ï¸</button>
          </td>
        </tr>`; 
        sumTotal += r.quantity * r.value; 
        sumWithdraw += r.withdraw; 
      });
      
      const remaining = sumTotal - sumWithdraw;
      container.innerHTML = `
        <table id="accountTable">
          <tr>
            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
            <th>Ø§Ù„Ø³Ø­Ø¨</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
          ${rows}
          <tr style='font-weight:bold;background:#ffd'>
            <td colspan=3>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</td>
            <td>${sumTotal}</td>
            <td colspan=3></td>
          </tr>
          <tr style='font-weight:bold;background:#fdd'>
            <td colspan=3>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø³Ø­Ø¨:</td>
            <td>${sumWithdraw}</td>
            <td colspan=3></td>
          </tr>
          <tr style='font-weight:bold;background:#dfd'>
            <td colspan=3>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</td>
            <td>${remaining}</td>
            <td colspan=3></td>
          </tr>
        </table>
        <br>
        <button class="btn btn-success" onclick="saveAllChanges()">ğŸ’¾ Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>`;
    }

    function toggleEditMode() {
      isEditMode = !isEditMode;
      const button = document.querySelector('#viewForm .btn-warning');
      
      if (isEditMode) {
        button.textContent = 'ğŸ‘ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶';
        button.classList.add('btn-success');
        button.classList.remove('btn-warning');
      } else {
        button.textContent = 'âœï¸ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
        button.classList.add('btn-warning');
        button.classList.remove('btn-success');
      }
      
      // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
      if (currentAccountName) {
        viewAccount();
      }
    }

    function updateRecord(index) {
      const data = JSON.parse(localStorage.getItem("accounts") || "{}");
      const records = data[currentAccountName];
      
      const quantity = Number(document.getElementById(`editQty${index}`).value);
      const value = Number(document.getElementById(`editVal${index}`).value);
      const withdraw = Number(document.getElementById(`editWithdraw${index}`).value);
      const inform = document.getElementById(`editInform${index}`).value;
      
      if (isNaN(quantity) || isNaN(value) || isNaN(withdraw)) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ… ØµØ­ÙŠØ­Ø©");
        return;
      }
      
      records[index] = {
        quantity,
        value,
        withdraw,
        total: quantity * value,
        date: records[index].date,
        inform
      };
      
      localStorage.setItem("accounts", JSON.stringify(data));
      autoBackup();
      
      document.getElementById(`editTotal${index}`).textContent = quantity * value;
      viewAccount();
      renderStats();
      
      alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„");
    }

    function deleteRecord(index) {
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ")) return;
      
      const data = JSON.parse(localStorage.getItem("accounts") || "{}");
      const records = data[currentAccountName];
      
      records.splice(index, 1);
      
      if (records.length === 0) {
        delete data[currentAccountName];
      } else {
        data[currentAccountName] = records;
      }
      
      localStorage.setItem("accounts", JSON.stringify(data));
      autoBackup();
      
      viewAccount();
      renderStats();
      
      alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„");
    }

    function saveAllChanges() {
      const data = JSON.parse(localStorage.getItem("accounts") || "{}");
      const records = data[currentAccountName];
      
      for (let i = 0; i < records.length; i++) {
        const quantity = Number(document.getElementById(`editQty${i}`).value);
        const value = Number(document.getElementById(`editVal${i}`).value);
        const withdraw = Number(document.getElementById(`editWithdraw${i}`).value);
        const inform = document.getElementById(`editInform${i}`).value;
        
        if (!isNaN(quantity) && !isNaN(value) && !isNaN(withdraw)) {
          records[i] = {
            quantity,
            value,
            withdraw,
            total: quantity * value,
            date: records[i].date,
            inform
          };
        }
      }
      
      localStorage.setItem("accounts", JSON.stringify(data));
      autoBackup();
      alert("âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª");
      viewAccount();
      renderStats();
    }

    function deleteAccount() {
      const name = document.getElementById('deleteName').value.trim();
      const data = JSON.parse(localStorage.getItem("accounts") || "{}");
      if (!data[name]) { 
        document.getElementById("deleteResult").innerHTML = "âŒ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"; 
        return; 
      }
      delete data[name]; 
      localStorage.setItem("accounts", JSON.stringify(data));
      autoBackup();
      document.getElementById("deleteResult").innerHTML = "âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù";
      renderStats();
    }

    function listAccounts() {
      const data = JSON.parse(localStorage.getItem("accounts") || "{}");
      const names = Object.keys(data);
      document.getElementById("accountsList").innerHTML = 
        names.length === 0 ? 
        "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª</p>" : 
        "<ul>" + names.map(n => `<li>${n}</li>`).join('') + "</ul>";
    }

    function changePassword() {
      const oldP = document.getElementById("oldPassword").value;
      const newP = document.getElementById("newPassword").value;
      const confirmP = document.getElementById("confirmPassword").value;
      const current = localStorage.getItem("accountPassword");
      if (oldP !== current) { 
        document.getElementById("passwordChangeResult").innerHTML = "âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©"; 
        return; 
      }
      if (newP !== confirmP || newP.length < 3) { 
        document.getElementById("passwordChangeResult").innerHTML = "âŒ ØºÙŠØ± ØµØ§Ù„Ø­"; 
        return; 
      }
      localStorage.setItem("accountPassword", newP);
      document.getElementById("passwordChangeResult").innerHTML = "âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
    }

    function exportToExcel() {
      const table = document.getElementById("accountTable");
      const name = document.getElementById("viewName").value.trim();
      if (!table) return alert("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„");
      
      const tempTable = table.cloneNode(true);
      const actionCells = tempTable.querySelectorAll('td:last-child');
      actionCells.forEach(cell => {
        if (cell.querySelector('button')) {
          cell.remove();
        }
      });
      
      let html = `<html><head><meta charset='utf-8'></head><body><h3>Ø§Ù„Ø­Ø³Ø§Ø¨: ${name}</h3>${tempTable.outerHTML}</body></html>`;
      const blob = new Blob([html], { type: "application/vnd.ms-excel" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); 
      a.href = url; 
      a.download = `${name}.xls`; 
      a.click();
    }

    function renderStats(){
      const data = JSON.parse(localStorage.getItem("accounts") || "{}");
      let totalAccounts = Object.keys(data).length;
      let sumTotal = 0, sumWithdraw = 0;
      
      const statsContainer = document.getElementById("statsContainer"); 
      statsContainer.innerHTML = "";
      
      let labels = [], totals = [], withdraws = [];
      
      for(const name in data){
        let st = 0, sw = 0; 
        data[name].forEach(r => { st += r.total; sw += r.withdraw; });
        sumTotal += st; 
        sumWithdraw += sw;
        labels.push(name); 
        totals.push(st); 
        withdraws.push(sw);
      }
      
      const stats = [
        {title: "Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª", value: totalAccounts},
        {title: "Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ", value: sumTotal},
        {title: "Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø²Ø­Ø¨", value: sumWithdraw},
        {title: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ", value: sumTotal - sumWithdraw}
      ];
      
      stats.forEach(s => {
        statsContainer.innerHTML += `<div class='stat-item'><h3>${s.value}</h3><p>${s.title}</p></div>`;
      });
      
      renderChart(labels, totals, withdraws);
    }

    function renderSummaryTable() {
      const data = JSON.parse(localStorage.getItem("accounts") || "{}");
      const summaryBody = document.querySelector("#summaryTable tbody"); 
      summaryBody.innerHTML = "";
      
      for(const name in data){
        let st = 0, sw = 0; 
        data[name].forEach(r => { st += r.total; sw += r.withdraw; });
        summaryBody.innerHTML += `<tr><td>${name}</td><td>${st}</td><td>${sw}</td><td>${st - sw}</td></tr>`;
      }
    }

    function renderChart(labels, totals, withdraws){
      const ctx = document.getElementById("accountsChart");
      if(chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
              data: totals,
              backgroundColor: 'rgba(52,152,219,0.7)'
            },
            {
              label: 'Ø§Ù„Ø³Ø­Ø¨',
              data: withdraws,
              backgroundColor: 'rgba(231,76,60,0.7)'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top'
            }
          }
        }
      });
    }

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    function backupData() {
      const data = localStorage.getItem("accounts");
      const blob = new Blob([data], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `backup_accounts_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©");
    }

    function restoreData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (confirm("âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ Ø³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©.")) {
            localStorage.setItem("accounts", JSON.stringify(data));
            alert("âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
            renderStats();
          }
        } catch (error) {
          alert("âŒ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
        }
      };
      reader.readAsText(file);
    }

    function exportToCSV() {
      const data = JSON.parse(localStorage.getItem("accounts") || "{}");
      let csv = "Ø§Ù„Ø§Ø³Ù…,Ø§Ù„ÙƒÙ…ÙŠØ©,Ø§Ù„Ù‚ÙŠÙ…Ø©,Ø§Ù„Ø³Ø­Ø¨,Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ,Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„ØªÙØ§ØµÙŠÙ„\n";
      
      for (const name in data) {
        data[name].forEach(record => {
          csv += `"${name}",${record.quantity},${record.value},${record.withdraw},${record.total},"${record.date}","${record.inform}"\n`;
        });
      }
      
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv; charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `accounts_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }

    function exportToExcelAll() {
      const data = JSON.parse(localStorage.getItem("accounts") || "{}");
      let html = `<html><head><meta charset='utf-8'><title>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</title></head><body>`;
      html += `<h1>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª - ${new Date().toLocaleDateString('ar-EG')}</h1>`;
      
      for (const name in data) {
        html += `<h2>Ø§Ù„Ø­Ø³Ø§Ø¨: ${name}</h2>`;
        html += `<table border="1"><tr><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th>Ø§Ù„Ø³Ø­Ø¨</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th></tr>`;
        
        data[name].forEach(record => {
          html += `<tr><td>${record.quantity}</td><td>${record.value}</td><td>${record.withdraw}</td><td>${record.total}</td><td>${record.date}</td><td>${record.inform}</td></tr>`;
        });
        
        html += `</table><br>`;
      }
      
      html += `</body></html>`;
      const blob = new Blob([html], { type: "application/vnd.ms-excel" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `all_accounts_${new Date().toISOString().split('T')[0]}.xls`;
      a.click();
    }

    function autoBackup() {
      try {
        const data = localStorage.getItem("accounts");
        const timestamp = new Date().toISOString();
        localStorage.setItem(`autoBackup_${timestamp}`, data);
        
        // Ø­ÙØ¸ Ø¢Ø®Ø± 5 Ù†Ø³Ø® ÙÙ‚Ø·
        const backups = Object.keys(localStorage)
          .filter(key => key.startsWith('autoBackup_'))
          .sort()
          .reverse();
        
        if (backups.length > 5) {
          for (let i = 5; i < backups.length; i++) {
            localStorage.removeItem(backups[i]);
          }
        }
      } catch (error) {
        console.log("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ");
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    window.addEventListener('load', function() {
      const backups = Object.keys(localStorage)
        .filter(key => key.startsWith('autoBackup_'))
        .sort()
        .reverse();
      
      if (backups.length > 0 && !localStorage.getItem("accounts")) {
        if (confirm("ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§ØŸ")) {
          const backupData = localStorage.getItem(backups[0]);
          localStorage.setItem("accounts", backupData);
        }
      }
    });
  </script>
</body>
</html>
